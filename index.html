<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bill Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --bg-color: #f7f7f7;
            --text-color: #000;
            --card-bg: #fff;
            --table-header: #eaeaea;
            --accent: #1e88e5;
            --accent-hover: #1565c0;
        }
        body.dark-mode {
            --bg-color: #1e1e1e;
            --text-color: #f1f1f1;
            --card-bg: #2c2c2c;
            --table-header: #444;
            --accent: #64b5f6;
            --accent-hover: #42a5f5;
        }

        /* --- Animated Background --- */
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #e0eafc, #cfdef3);
            background-size: 400% 400%;
            animation: gradient-animation 15s ease infinite;
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #2c3e50, #4ca1af);
            background-size: 400% 400%;
            animation: gradient-animation 15s ease infinite;
        }

        body:hover {
            background-position: 100% 50%;
            transition: background-position 0.5s ease;
        }

        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- Loading Spinner Styles --- */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #fff;
            border-top: 5px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* --- Existing Styles --- */
        * { box-sizing: border-box; transition: all 0.3s ease-in-out; }
        .theme-switch { position: fixed; top:10px; right:10px; z-index:999; }
        .switch { position: relative; display: inline-block; width: 60px; height: 30px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#ccc; border-radius:34px; }
        .slider:before { position:absolute; content:'‚òÄÔ∏è'; height:26px; width:26px; left:2px; bottom:2px; background-color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; transition:0.4s; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform:translateX(30px); content:'üåô'; }

        #invoice { max-width:900px; margin:auto; background: var(--card-bg); padding:20px; border-radius:10px; box-shadow:0 0 12px rgba(0,0,0,0.1); }
        h2,h4,p { text-align:center; margin:5px 0; }

        .form-columns { display:flex; justify-content:space-between; width:100%; margin-top:20px; }
        .form-column { width:48%; }

        .form-group { margin-bottom:10px; display:flex; gap:10px; }
        label { width:180px; font-weight:bold; }
        input,textarea { flex:1; padding:6px; border-radius:4px; border:1px solid #ccc; background: var(--card-bg); color: var(--text-color); width:100%; }
        
        input:hover, textarea:hover {
            transform: scale(1.02);
            border-color: var(--accent);
            box-shadow: 0 0 8px rgba(0,0,0,0.2);
        }

        input:focus,textarea:focus { border-color: var(--accent); box-shadow:0 0 4px var(--accent); }
        
        table { width:100%; border-collapse:collapse; margin-top:20px; }
        th,td { border:1px solid #444; padding:8px; text-align:center; }
        th { background: var(--table-header); }
        td[contenteditable="true"]:hover { background: var(--accent); color:white; }
        
        .totals-section { text-align: right; padding: 10px 0; }
        .totals-section div { display: flex; justify-content: flex-end; align-items: center; gap: 20px; margin-bottom: 5px; }
        .totals-section span { font-weight: bold; width: 100px; text-align: left; }

        .btn { padding:10px 16px; background: var(--accent); color:white; border:none; border-radius:5px; margin:10px 5px 0 0; cursor:pointer; transition:0.3s ease; }
        .btn:hover { background: var(--accent-hover); transform:scale(1.05); }
        .btn-danger { background:#f44336; }
        .btn-danger:hover { background:#d32f2f; }

        .no-print { text-align:center; }
        .pdf-hide-only { display:table-cell; }
        .pdf-hide { display:inline-block; }

        /* General Mobile-first adjustments */
        @media (max-width: 768px) { 
            body { padding: 10px; }
            #invoice { padding: 15px; }
            .form-columns { flex-direction: column; }
            .form-column { width: 100%; }
            .form-group { flex-direction: column; align-items: flex-start; gap: 5px; }
            label { width: 100%; }
            
            table { width: 100%; display: block; overflow-x: auto; white-space: nowrap; }
            thead { display: none; }
            tbody { display: block; width: 100%; }
            tbody tr { display: flex; flex-direction: column; border: 1px solid #ccc; margin-bottom: 10px; padding: 10px; border-radius: 5px; }
            tbody td { 
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 5px;
                border: none;
                text-align: right;
            }
            tbody td::before { 
                content: attr(data-label);
                font-weight: bold;
                text-align: left;
                flex-grow: 1;
                margin-right: 10px;
            }
            tbody td:last-child { text-align: center; }

            .totals-section { 
                padding: 10px 5px;
                text-align: left;
            }
            .totals-section div, .totals-section h3 {
                justify-content: space-between;
                gap: 0;
            }
            .totals-section span { width: auto; text-align: right; }
            
            .no-print button { width: 100%; margin-bottom: 10px; }
        }
        
        /* Media query specifically for printing and PDF generation */
        @media print { 
            .no-print, .theme-switch, .remove-btn, th.remove-col, .loading-overlay { display: none !important; } 
            
            input, textarea { 
                border: none !important;
                background: none !important;
                outline: none !important;
                box-shadow: none !important;
                padding: 0;
            }
            .form-group { align-items: flex-start; }
            label { width: 180px; }

            .pdf-hide-only { display: none !important; }
            
            .form-columns { flex-direction: row; justify-content: space-between; }
            .form-column { width: 48%; }
            .form-group { flex-direction: row; align-items: center; }
            
            table { width: 100%; display: table; }
            thead { display: table-header-group; }
            tbody { display: table-row-group; }
            tbody tr { display: table-row; page-break-inside: avoid; }
            tbody td { display: table-cell; border: 1px solid #444; padding: 8px; }
            tbody td::before { display: none; }
            
            .totals-section { text-align: right; }
            .totals-section div, .totals-section h3 {
                justify-content: flex-end;
                gap: 20px;
            }
        }
    </style>
</head>
<body>

<div class="theme-switch">
    <label class="switch"><input type="checkbox" onchange="document.body.classList.toggle('dark-mode')"><span class="slider"></span></label>
</div>

<div id="invoice">
    <div class="loading-overlay">
        <div class="spinner"></div>
    </div>
    <h2>SWEZEN POWER SOLUTIONS</h2>
    <h4>B-112 SHAILJA HOMES, RADHANPUR ROAD, MAHESANA, GUJARAT - 384002</h4>
    <p>GSTIN: 24AFKFS8288K1Z5</p>
    <p>Contact: +91 9662777888 | sweszenpowersolution2615@gmail.com</p>
    <hr>

    <div class="form-columns">
        <div class="form-column">
            <div class="form-group"><label>Invoice Number:</label><span class="print-value" id="printRefNo"></span><input type="text" id="refNo" placeholder="Invoice Number"></div>
            <div class="form-group"><label>Invoice Date:</label><span class="print-value" id="printBillDate"></span><input type="date" id="billDate" placeholder="Invoice Date"></div>
            <div class="form-group"><label>Customer Name:</label><span class="print-value" id="printCustomerName"></span><input type="text" id="customerName" placeholder="Customer Name"></div>
            <div class="form-group"><label>Address:</label><span class="print-value" id="printAddress"></span><textarea id="address" rows="2" placeholder="Address"></textarea></div>
            <div class="form-group"><label>State:</label><span class="print-value" id="printState"></span><input type="text" id="state" value="Gujarat" placeholder="State"></div>
        </div>
        <div class="form-column">
            <div class="form-group"><label>Transport Mode:</label><span class="print-value" id="printTransportMode"></span><input type="text" id="transportMode" placeholder="Transport Mode"></div>
            <div class="form-group"><label>Vehicle Number:</label><span class="print-value" id="printVehicleNumber"></span><input type="text" id="vehicleNumber" placeholder="Vehicle Number"></div>
            <div class="form-group"><label>Date of Supply:</label><span class="print-value" id="printSupplyDate"></span><input type="date" id="supplyDate" placeholder="Date of Supply"></div>
            <div class="form-group"><label>E-Way Bill No:</label><span class="print-value" id="printEwayBillNo"></span><input type="text" id="ewayBillNo" placeholder="E-Way Bill No"></div>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>Sr</th>
                <th style="width: 30%;">Material</th>
                <th>HSN</th>
                <th>Qty</th>
                <th>Rate</th>
                <th class="pdf-hide-only">GST%</th>
                <th class="pdf-hide-only">Total</th>
                <th class="pdf-hide-only remove-btn remove-col">Remove</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <div class="totals-section">
        <div>Subtotal: <span id="subTotal">‚Çπ 0.00</span></div>
        <div id="sgst-line" class="tax-line">SGST: <span id="sgstTotal">‚Çπ 0.00</span></div>
        <div id="cgst-line" class="tax-line">CGST: <span id="cgstTotal">‚Çπ 0.00</span></div>
        <div id="igst-line" class="tax-line">IGST: <span id="igstTotal">‚Çπ 0.00</span></div>
        <h3 style="margin-top: 10px;">Grand Total: <span id="grandTotal">‚Çπ 0.00</span></h3>
    </div>

    <div class="no-print pdf-hide">
        <button class="btn" onclick="validateBeforeAdd()">+ Add Material</button>
        <button class="btn" onclick="generatePDF()">Download PDF</button>
    </div>
</div>

<script>
function validateFields() {
    const ids = ['refNo','billDate','customerName','address'];
    for(let id of ids){ if(!document.getElementById(id).value.trim()){ alert("Please fill in all required fields."); return false; } }
    const rows = document.querySelectorAll("#tableBody tr");
    for(let row of rows){ 
        const desc = row.cells[1].innerText.trim();
        const qty = row.querySelector(".qty").value.trim();
        const rate = row.querySelector(".rate").value.trim();
        if(!desc||!qty||!rate){ alert("Please complete all material rows."); return false; } 
    }
    return true;
}

function validateBeforeAdd(){ if(validateFields() || document.querySelectorAll("#tableBody tr").length===0){ addRow(); } }

function addRow(){
    const tbody = document.getElementById("tableBody");
    const row = tbody.insertRow();
    row.innerHTML = `
        <td data-label="Sr"></td>
        <td data-label="Material" contenteditable="true"></td>
        <td data-label="HSN"><input class="hsn" type="text" value="" placeholder="HSN"></td>
        <td data-label="Qty"><input class="qty" type="number" value="" placeholder="Qty"></td>
        <td data-label="Rate"><input class="rate" type="number" value="" placeholder="Rate"></td>
        <td class="pdf-hide-only" data-label="GST%"><input class="gst" type="number" value="" placeholder="GST%"></td>
        <td class="pdf-hide-only" data-label="Total">‚Çπ 0.00</td>
        <td class="pdf-hide-only remove-btn" data-label="Remove"><button class="btn btn-danger" onclick="removeRow(this)">X</button></td>`;
    row.querySelector(".qty").addEventListener("input", calculateTotal);
    row.querySelector(".rate").addEventListener("input", calculateTotal);
    row.querySelector(".gst").addEventListener("input", calculateTotal);
    
    calculateTotal();
}

function removeRow(btn){ btn.closest("tr").remove(); calculateTotal(); }

function calculateTotal(){
    let subTotal=0;
    let totalGST=0;
    const isGujarat = document.getElementById('state').value.toLowerCase() === 'gujarat';

    const rows = document.querySelectorAll("#tableBody tr");
    let visibleIndex = 1;

    rows.forEach(row=>{
        const qty = parseFloat(row.querySelector(".qty").value) || 0;
        const rate = parseFloat(row.querySelector(".rate").value) || 0;
        const gst = parseFloat(row.querySelector(".gst").value) || 0;
        const base = qty * rate;
        const gstAmt = (base * gst / 100);
        const rowTotal = base + gstAmt;

        row.cells[0].innerText = visibleIndex++;
        row.cells[6].innerText = `‚Çπ ${rowTotal.toFixed(2)}`;
        
        subTotal += base;
        totalGST += gstAmt;
    });

    const grandTotal = subTotal + totalGST;
    
    document.getElementById("subTotal").innerText = `‚Çπ ${subTotal.toFixed(2)}`;
    document.getElementById("grandTotal").innerText = `‚Çπ ${grandTotal.toFixed(2)}`;
    
    if (isGujarat) {
        document.getElementById("sgstTotal").innerText = `‚Çπ ${(totalGST / 2).toFixed(2)}`;
        document.getElementById("cgstTotal").innerText = `‚Çπ ${(totalGST / 2).toFixed(2)}`;
        document.getElementById('sgst-line').style.display = 'flex';
        document.getElementById('cgst-line').style.display = 'flex';
        document.getElementById('igst-line').style.display = 'none';
    } else {
        document.getElementById('sgst-line').style.display = 'none';
        document.getElementById('cgst-line').style.display = 'none';
        document.getElementById("igstTotal").innerText = `‚Çπ ${totalGST.toFixed(2)}`;
        document.getElementById('igst-line').style.display = 'flex';
    }
}

document.getElementById('state').addEventListener('input', calculateTotal);

function generatePDF(){
    if(!validateFields()) return;
    if(document.querySelectorAll("#tableBody tr").length===0){ alert("Please add at least one material."); return; }

    const loadingOverlay = document.querySelector('.loading-overlay');
    loadingOverlay.classList.add('show');

    const originalDisplay = {};
    document.querySelectorAll(".no-print, .pdf-hide, .remove-btn, th.remove-col").forEach(el=>{
        originalDisplay[el] = el.style.display;
        el.style.display = "none";
    });
    
    const inputs = document.querySelectorAll('.form-group input, .form-group textarea, #tableBody input');
    inputs.forEach(input => {
        const span = document.getElementById(`print${input.id.charAt(0).toUpperCase() + input.id.slice(1)}`);
        if(span) {
            span.textContent = input.value;
            input.style.display = 'none';
        }
    });

    const isGujarat = document.getElementById('state').value.toLowerCase() === 'gujarat';
    if(isGujarat){
        document.getElementById('sgst-line').style.display = 'flex';
        document.getElementById('cgst-line').style.display = 'flex';
        document.getElementById('igst-line').style.display = 'none';
    } else {
        document.getElementById('sgst-line').style.display = 'none';
        document.getElementById('cgst-line').style.display = 'none';
        document.getElementById('igst-line').style.display = 'flex';
    }

    setTimeout(()=>{
        html2pdf().from(document.getElementById("invoice")).set({
            margin:0.5,
            filename:`Bill_${document.getElementById("refNo").value || 'Invoice'}.pdf`,
            html2canvas:{scale:2},
            jsPDF:{format:'a4', orientation:'portrait'}
        }).save().finally(()=>{
            loadingOverlay.classList.remove('show');
            for(let el in originalDisplay){
                el.style.display = originalDisplay[el];
            }
            inputs.forEach(input => {
                const span = document.getElementById(`print${input.id.charAt(0).toUpperCase() + input.id.slice(1)}`);
                if(span) {
                    input.style.display = '';
                    span.textContent = '';
                }
            });
        });
    }, 2000); // 2000ms = 2 seconds
}
</script>
</body>
</html>
